# AGENTS.md — Evencio Marketing Tools
**Authority:** Single ruleset for coding agents. Follow completely.

---

## Core Behavior

**Reality over model.** When reality contradicts your model, your model is wrong. Stop. Fix the model.

**Default:** Implement changes, don't just suggest. Read relevant files first.

**Agent notes:**
- Requires explicit requests for thoroughness
- Explain WHY rules matter (generalizes from explanations)
- "I don't know" is valid—better than confident confabulation

**Confidentiality:**
- NEVER mention AI tools, model vendors, or internal tooling in commits, branches, PRs, or code comments
- No "Generated by", "Co-Authored-By", or similar attributions
- This is company OSS—external parties must not know tooling details
- Internal agent configs are gitignored (e.g., `.claude/`, `CLAUDE.md`, `AGENTS.md`, `.codex/`)

---

## Commands

```bash
bun run dev          # Start dev server (port 3000)
bun run build        # Production build
bun run start        # Run production server
bun run lint         # Biome lint
bun run lint:fix     # Auto-fix lint issues
bun run format       # Format with Biome
bun run test         # Run tests (when added)
```

---

## Commit Requirements

- Before every commit, run `bun run lint`, `bun run test`, and `bun run build`. Why: keeps the mainline green and catches integration regressions early.
- If any of these fail, fix and re-run until they pass.
- If failures indicate a deeper breakage (blocked tests, build crashes, or widespread lint errors), stop and report the failures with context to the user for guidance.

---

## Project Overview

Open-source marketing tool for event organizers. Creates:
- Social media images (Instagram, Facebook, Twitter/X, LinkedIn)
- Event posters and flyers (A4, A3, Letter, custom)

**Stack:**
- TanStack Start (React full-stack framework)
- Bun runtime with Nitro preset
- Vite build system
- Fabric.js for canvas manipulation
- Zustand for state management
- TanStack Query for data fetching
- shadcn/ui with new-york style
- Biome for linting/formatting

---

## Architecture

```
src/
├── routes/           # TanStack Router file-based routes
├── components/
│   ├── ui/           # shadcn/ui components
│   └── editor/       # Canvas editor components
├── lib/
│   ├── export/       # PNG/JPEG/PDF export utilities
│   └── utils.ts      # Shared utilities
├── stores/           # Zustand stores
├── types/            # TypeScript types
└── styles.css        # Global styles with Tailwind
```

**Key patterns:**
- Routes in `src/routes/` (TanStack Router file-based)
- Editor components use Fabric.js canvas
- State in Zustand stores (view-state only)
- Export utilities for multi-format output

---

## Generated Files

- **Do not edit `src/routeTree.gen.ts` by hand.** It is auto-generated by TanStack Router; manual edits will be overwritten and can desync routing. Why: keeping the router output deterministic prevents broken navigation and hard-to-debug mismatches.
- If routes change, update the route files and let the router generator rebuild the file (e.g. via the normal dev/build workflow). Why: source-of-truth stays in `src/routes/`.

---

## Snippet Editor Structure (snippets/new)

Keep the snippet editor modular so the route file never balloons again. Why: smaller units are easier to reason about, review, and test, and they reduce merge conflicts when multiple people work on the editor.

**Where things live:**
- Route orchestrator: `src/routes/snippets.new.tsx` (routing, form setup, wiring panels, submit flow).
- UI panels and chrome: `src/routes/-snippets/new/components/`
  - `panel-rail.tsx`, `details-panel.tsx`, `examples-panel.tsx`, `imports-panel.tsx`
  - `editor-panel.tsx`, `snippet-header.tsx`, `snippet-file-overlays.tsx`
  - `snippet-screen-guard.tsx`, `preview-header-actions.tsx`
- State/effects hooks: `src/routes/-snippets/new/hooks/`
  - `use-snippet-panels.ts`, `use-snippet-filters.ts`
  - `use-snippet-component-exports.ts`, `use-derived-snippet-props.ts`
- Shared helpers/types: `src/routes/-snippets/new/`
  - `snippet-file-utils.ts`, `snippet-editor-types.ts`, `snippet-asset-builders.ts`
  - `constants.ts`, `schema.ts`, `editor.tsx`

**Anti-bloat rules:**
- New UI or logic should go into a component/hook/util; keep `snippets.new.tsx` as composition only.
- If a block grows past ~60-80 lines or introduces new state/effects, extract it. Why: keeps responsibilities clear and makes targeted tests possible.
- Prefer dedicated helpers for string parsing, file transforms, and asset metadata instead of inline logic. Why: reduces accidental regressions and improves reuse.

---

## Test Structure (Bun Native)

- Co-locate tests in `__tests__` beside the code they cover (e.g., `src/lib/storage/__tests__/autosave.test.ts`). Why: keeps intent close to implementation so refactors update tests alongside code.
- Name files `*.test.ts` or `*.test.tsx` and keep one primary subject per file. Why: predictable discovery in Bun and faster navigation when editing.
- Shared setup lives in `tests/setup/` and shared helpers in `tests/utils/`. Why: avoids hidden globals and keeps individual tests focused.
- Use Bun's `bun:test` APIs; prefer `vi.spyOn` + targeted `mock.module` inside each file and clean up with `afterEach`/`afterAll`. Why: prevents cross-test contamination and flaky order-dependent behavior.
- For DOM tests, rely on the Happy DOM setup from `bunfig.toml` + `tests/setup/test-setup.ts` and avoid browser-only APIs. Why: we run native Bun tests only, so the environment must stay deterministic.
- For IndexedDB tests, use `fake-indexeddb` helpers in `tests/utils/indexeddb.ts` and reset per test. Why: deterministic ordering is essential for autosave/migration correctness.

---

## Persistence Notes

- Autosave and manual save both write full slide JSON to IndexedDB. Without write ordering, a slow autosave can finish after a manual save and overwrite newer state, causing reloads to revert. Writes must be serialized per slide to avoid stale saves winning.

---

## Rules Directory

This file is complemented by `.claude/rules/` which contains:

| Rule File | Scope | Purpose |
|-----------|-------|---------|
| `execution-protocol.md` | All | Prediction protocol, failure handling |
| `quality-standards.md` | All | First-pass quality, root cause |
| `ui-components.md` | `**/*.tsx` | TanStack Start patterns |
| `testing.md` | `**/*.test.ts` | Vitest conventions |
| `wiring-completeness.md` | All | Export and connection checks |
| `known-problems.md` | All | TanStack Query, Zustand issues |
| `enforcement-gate.md` | All | Compliance checklist |
| `opencode-external-rules.md` | All | OpenCode documentation references |

Rules are auto-loaded. Path-scoped rules only apply when touching matching files.

---

## Brand Identity

This project follows the **Swiss International 2026** design system from Evencio.

**Quick reference:**
- Typography: Lexend Exa (headlines), Inter (body), Unbounded (logo wordmark only)
- Colors: Neutral-first palette with Brand Blue #0044FF (logo only)
- Patterns: 1px borders (`border-neutral-200`), no shadows, grid-based layouts

For comprehensive brand guidelines including logo SVG code, social media specs, and component patterns, use the `/evencio-brand-identity` skill.

---
